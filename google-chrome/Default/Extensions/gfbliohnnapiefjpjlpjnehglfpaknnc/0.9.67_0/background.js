"use strict";function loadRawSettings(e,t,n){var o=n||{};chrome.storage.local.get(null,function(n){var r=n.savedAt||0;chrome.storage.sync.get(null,function(i){var a=i.savedAt||0;r>a?(extendObject(o,n),_save(chrome.storage.sync,n,function(){var n=getSubSettings(o,e);chrome.runtime.lastError&&(n.error="Settings sync may not work thoroughly because of: "+chrome.runtime.lastError.message),t(n)})):r<a?(extendObject(o,i),t(getSubSettings(o,e)),_save(chrome.storage.local,i)):(extendObject(o,n),t(getSubSettings(o,e)))})})}function _applyProxySettings(e){if(e.proxyMode&&"clear"!==e.proxyMode){var t=e.autoproxy_hosts.map(function(e){return e.filter(function(e){return e.indexOf("*")!==-1}).join("|")}),n=e.autoproxy_hosts.map(function(e){return dictFromArray(e.filter(function(e){return e.indexOf("*")===-1}),1)}),o={mode:["always","byhost","bypass"].indexOf(e.proxyMode)!==-1?"pac_script":e.proxyMode,pacScript:{data:"var pacGlobal = {\n                        hosts: "+JSON.stringify(n)+",\n                        autoproxy_pattern: "+JSON.stringify(t)+",\n                        proxyMode: '"+e.proxyMode+"',\n                        proxy: "+JSON.stringify(e.proxy)+'\n                    };\n                    function FindProxyForURL(url, host) {\n                        var lastPos;\n                        if (pacGlobal.proxyMode === "always") {\n                            return pacGlobal.proxy[0];\n                        } else if (pacGlobal.proxyMode === "bypass") {\n                            var pp = new RegExp(pacGlobal.autoproxy_pattern[0]);\n                            do {\n                                if (pacGlobal.hosts[0].hasOwnProperty(host)\n                                    || (pacGlobal.autoproxy_pattern[0].length && pp.test(host))) {\n                                    return "DIRECT";\n                                }\n                                lastPos = host.indexOf(\'.\') + 1;\n                                host = host.slice(lastPos);\n                            } while (lastPos >= 1);\n                            return pacGlobal.proxy[0];\n                        } else {\n                            for (var i = 0; i < pacGlobal.proxy.length; i++) {\n                                var pp = new RegExp(pacGlobal.autoproxy_pattern[i]);\n                                var ahost = host;\n                                do {\n                                    if (pacGlobal.hosts[i].hasOwnProperty(ahost)\n                                        || (pacGlobal.autoproxy_pattern[i].length && pp.test(ahost))) {\n                                        return pacGlobal.proxy[i];\n                                    }\n                                    lastPos = ahost.indexOf(\'.\') + 1;\n                                    ahost = ahost.slice(lastPos);\n                                } while (lastPos >= 1);\n                            }\n                            return "DIRECT";\n                        }\n                    }'}};chrome.proxy.settings.set({value:o,scope:"regular"},function(){})}else chrome.proxy.settings.clear({scope:"regular"})}function request(e,t,n,o,r){return n=n||{},new Promise(function(t,r){var i=new XMLHttpRequest,a=void 0!==o?"POST":"GET";i.open(a,e);for(var s in n)i.setRequestHeader(s,n[s]);i.onload=function(){t(i.responseText)},i.onerror=r.bind(null,i),i.send(o)}).then(t)["catch"](function(e){r&&r(e)})}function dictFromArray(e,t){var n={};return e.forEach(function(e){n[e]=t}),n}function extendObject(e,t){for(var n in t)e[n]=t[n]}function getSubSettings(e,t){var n;return t?(t instanceof Array||(t=[t]),n={},t.forEach(function(t){n[t]=e[t]})):n=e,n}function _save(e,t,n){t.localPath&&delete t.snippets,e.set(t,n)}var Gist=function(){function e(e,t,n){request("https://api.github.com/gists",function(o){var r=JSON.parse(o),i="";r.forEach(function(e){e.hasOwnProperty("description")&&e.description===t&&e.files.hasOwnProperty(t)&&(i=e.id)}),""===i?request("https://api.github.com/gists",function(e){var t=JSON.parse(e);n(t.id)},{Authorization:"token "+e},'{ "description": "'+t+'", "public": false, "files": { "'+t+'": { "content": "'+t+'" } } }'):n(i)},{Authorization:"token "+e})}function t(e,t){request("https://api.github.com/gists/"+s+"/comments",function(e){t&&t(e)},{Authorization:"token "+i},'{"body": "'+encodeURIComponent(e)+'"}')}function n(e,t){request("https://api.github.com/gists/"+s+"/comments/"+e,function(e){var n=JSON.parse(e);t({status:0,content:decodeURIComponent(n.body)})},{Authorization:"token "+i})}function o(e){request("https://api.github.com/gists/"+s+"/comments",function(t){c=JSON.parse(t).map(function(e){return e.id}),e(c)},{Authorization:"token "+i})}function r(e,t,n){request("https://api.github.com/gists/"+s+"/comments/"+e,function(e){n&&n(e)},{Authorization:"token "+i},'{"body": "'+encodeURIComponent(t)+'"}')}var i,a={},s="",c=[];return a.initGist=function(t,n){return i===t&&""!==s?s:(i=t,void e(i,"cloudboard",function(e){s=e,n&&n(s)}))},a.readComment=function(e,t){""===s?t({status:1,content:"Please call initGist first!"}):e>=c.length?o(function(o){e<o.length?n(o[e],t):t({status:1,content:"Register not exists!"})}):n(c[e],t)},a.editComment=function(e,n,i){""===s?i({status:1,content:"Please call initGist first!"}):e>=c.length?o(function(o){if(e<o.length)r(o[e],n,i);else{var a=function c(){s--,s>0?t(".",c):0===s&&t(n,i)},s=e-o.length+1;a()}}):r(c[e],n,i)},a}(),ChromeService=function(){function e(t,n){var o=n;if(""===t.title||t.hasOwnProperty("url")&&void 0!==t.url||(o+="/"+t.title,B.push({id:t.id,title:o+"/"})),t.hasOwnProperty("children"))for(var r=0;r<t.children.length;++r)e(t.children[r],o)}function t(e,n){e.path.length?chrome.bookmarks.create({parentId:e.folder,title:e.path.shift()},function(o){e.folder=o.id,t(e,n)}):chrome.bookmarks.create({parentId:e.folder,title:e.title,url:e.url},function(e){n(e)})}function n(e,t){var n={blacklist:{},marks:{},findHistory:[],cmdHistory:[],sessions:{},proxyMode:"clear",autoproxy_hosts:[],proxy:[]};loadRawSettings(e,function(e){"string"==typeof e.proxy&&(e.proxy=[e.proxy],e.autoproxy_hosts=[e.autoproxy_hosts]),e.localPath?request(e.localPath,function(n){e.snippets=n,t(e)},void 0,void 0,function(n){e.error="Failed to read snippets from "+e.localPath,t(e)}):t(e)},n)}function o(e){delete C[e],delete M[e],delete F[e],delete G[e],_=_.filter(function(t){return t!==e}),V.length&&chrome.tabs.create({active:!1,url:V.shift()}),f()}function r(e){if(M.hasOwnProperty(e)){var t=M[e];chrome.tabs.executeScript(e,{code:"_setScrollPos("+t.scrollLeft+", "+t.scrollTop+")"}),delete M[e]}}function i(e,t,n,o){t===-1?chrome.tabs.sendMessage(e,n):chrome.tabs.sendMessage(e,n,{frameId:t})}function a(e){D!==e&&(null!==D&&i(D,0,{subject:"tabDeactivated"}),i(e,0,{subject:"tabActivated"}),D=e)}function s(e){chrome.tabs.query({active:!0,currentWindow:!0},function(t){t.length>0&&e(t[0])})}function c(e,t,n){var o=L.pendingPorts.indexOf(e);o!==-1&&L.pendingPorts.splice(o,1),t(n)}function u(e,t){e.savedAt=(new Date).getTime(),_save(chrome.storage.local,e,function(){t&&t()}),_save(chrome.storage.sync,e,function(){if(chrome.runtime.lastError){chrome.runtime.lastError.message}})}function d(e){chrome.tabs.query({},function(t){t.forEach(function(t){i(t.id,-1,{subject:"settingsUpdated",settings:e})})})}function l(e,t){d(e),u(e,t)}function f(){H.showTabIndices&&chrome.tabs.query({currentWindow:!0},function(e){e.forEach(function(e){i(e.id,0,{subject:"tabIndexChange",index:e.index+1})})})}function h(e){return 0!==e.frameId&&"about:blank"===e.url?e.tab.url:e.url}function p(e,t,n){if(e.blacklist[".*"])return!0;if(t){if(e.blacklist[t.origin])return!0;if(n)return n=new RegExp(n.source,n.flags),n.test(t.href)}return!1}function m(e,t){request(e,function(n){l({localPath:e,snippets:n}),t({status:"Succeeded",snippets:n})},void 0,void 0,function(e){t({status:"Failed"})})}function b(e,t){return t&&t.length&&(e=e.filter(function(e){return e.title.indexOf(t)!==-1||e.url&&e.url.indexOf(t)!==-1})),e}function g(e,t){chrome.history.search({startTime:0,maxResults:2147483647,text:""},function(n){t&&(n=n.sort(function(e,t){return t.visitCount-e.visitCount})),e(n)})}function y(e,t){return e<0?e=0:e>=t&&(e=t),e}function v(e,t,n){return t>n-e&&(e-=t-(n-e)),e}function w(e,t){e?chrome.tabs.query({windowId:e.windowId},function(n){0==e.index&&t==-1?t=n.length-1:e.index==n.length-1&&1==t&&(t=1-n.length);var o=y(e.index+t,n.length-1);chrome.tabs.update(n[o].id,{active:!0})}):s(function(e){w(e,t)})}function x(e,t,n){e?chrome.tabs.query({windowId:e.windowId},function(o){var r=o.map(function(e){return e.id});t=y(t,o.length);var i=v(e.index,t,o.length);n(r.slice(i,i+t))}):s(function(e){x(e,t,n)})}function k(e,t){chrome.tabs.query({currentWindow:!0},function(n){n=n.map(function(e){return e.id}),chrome.tabs.remove(n.slice(e.tab.index+(t<0?t:1),e.tab.index+(t<0?0:1+t)))})}function T(e){return!/^view-source:|^javascript:/.test(e)&&/^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/\n]+)/im.test(e)&&(e=/^[\w-]+?:/i.test(e)?e:"http://"+e),e}function I(e,t,n){var o;if(e)switch(H.newTabPosition){case"left":o=e.index;break;case"right":o=e.index+1;break;case"first":o=0;break;case"last":break;default:o=e.index+1+U,U++}chrome.tabs.create({url:t,active:n.tab.active,index:o,pinned:n.tab.pinned,openerTabId:e.id},function(e){(n.scrollLeft||n.scrollTop)&&(M[e.id]={scrollLeft:n.scrollLeft,scrollTop:n.scrollTop})})}function q(){chrome.windows.getAll({populate:!1},function(e){e.forEach(function(e){chrome.windows.remove(e.id)})})}function P(e,t){n(["proxyMode","proxy","autoproxy_hosts"],function(n){if("deleteProxyPair"===e.operation)n.proxy.splice(e.number,1),n.autoproxy_hosts.splice(e.number,1);else if("set"===e.operation)n.proxyMode=e.mode,n.proxy=e.proxy,n.autoproxy_hosts=e.host;else if(e.mode&&(n.proxyMode=e.mode),e.number||(e.number=0),e.proxy&&(n.proxy[e.number]=e.proxy,n.autoproxy_hosts.length<=e.number&&(n.autoproxy_hosts[e.number]=[])),e.host){var o=dictFromArray(n.autoproxy_hosts[e.number],1),r=e.host.split(/\s*[ ,\n]\s*/);"toggle"===e.operation?r.forEach(function(e){o.hasOwnProperty(e)?delete o[e]:o[e]=1}):"add"===e.operation?r.forEach(function(e){o[e]=1}):r.forEach(function(e){delete o[e]}),n.autoproxy_hosts[e.number]=Object.keys(o)}var i={autoproxy_hosts:n.autoproxy_hosts,proxyMode:n.proxyMode,proxy:n.proxy};l(i),_applyProxySettings(n),t&&t(i)})}function S(e,t){var o=e[0],e=e.substr(1);"B"===o?chrome.bookmarks.remove(e,t):"H"===o?chrome.history.deleteUrl({url:e},t):"T"===o?(e=e.split(":").map(function(e){return parseInt(e)}),chrome.windows.update(e[0],{focused:!0},function(){chrome.tabs.remove(e[1],t)})):"M"===o&&n("marks",function(n){delete n.marks[e],l({marks:n.marks},t)})}function O(e,t){chrome.bookmarks.search({url:e},function(e){e.forEach(function(e){chrome.bookmarks.remove(e.id)}),t&&t()})}function R(e){for(var t=0;t<e.requestHeaders.length;++t)if("User-Agent"===e.requestHeaders[t].name){e.requestHeaders[t].value=z;break}return{requestHeaders:e.requestHeaders}}var L={},_=[],E=0,U=0,A=!1,C={},M={},G={},F={},j="chrome://newtab/",H={focusAfterClosed:"right",repeatThreshold:99,tabsMRUOrder:!0,newTabPosition:"default",showTabIndices:!1,interceptedErrors:[]},B=[];n(null,_applyProxySettings),chrome.tabs.onRemoved.addListener(o);var D=null;chrome.tabs.onUpdated.addListener(function(e,t,n){"loading"===t.status?delete G[e]:"complete"===t.status&&n.active&&a(e),r(e)}),chrome.windows.onFocusChanged.addListener(function(e){s(function(e){a(e.id)})}),chrome.tabs.onCreated.addListener(function(e){r(e.id),f()}),chrome.tabs.onMoved.addListener(function(){f()}),chrome.tabs.onActivated.addListener(function(e){A||e.tabId==_[_.length-1]||(_.length>10&&_.shift(),E!=_.length-1&&_.splice(E+1,_.length-1),_.push(e.tabId),E=_.length-1),C[e.tabId]=(new Date).getTime(),a(e.tabId),A=!1,U=0,r(e.tabId),f()}),chrome.tabs.onDetached.addListener(function(){f()}),chrome.tabs.onAttached.addListener(function(){f()}),chrome.commands.onCommand.addListener(function(e){switch(e){case"restartext":chrome.tabs.query({},function(e){e.forEach(function(e){chrome.tabs.reload(e.id)}),chrome.runtime.reload()});break;case"previousTab":case"nextTab":s(function(t){var n="previousTab"===e?t.index-1:t.index+1;chrome.tabs.query({windowId:t.windowId},function(e){n=(n%e.length+e.length)%e.length,chrome.tabs.update(e[n].id,{active:!0})})});break;case"closeTab":s(function(e){chrome.tabs.remove(e.id)});break;case"proxyThis":s(function(e){var t=new URL(e.url||e.pendingUrl).host;P({host:t,operation:"toggle"},function(){chrome.tabs.reload(e.id,{bypassCache:!0})})})}}),L.pendingPorts=[],chrome.runtime.onMessage.addListener(function(e,t,n){if(L.hasOwnProperty(e.action)){e.repeats>H.repeatThreshold&&(e.repeats=H.repeatThreshold);var o=L[e.action](e,t,n);if(e.needResponse)return o?(n(o),e.needResponse=!1):L.pendingPorts.push(e),e.needResponse}else console.log("[unexpected runtime message] "+JSON.stringify(e))}),L.toggleBlacklist=function(e,t,o){n("blacklist",function(n){var r=".*",i=t.origin||new URL(h(t)).origin;0!==chrome.extension.getURL("").indexOf(i)&&(r=i),n.blacklist.hasOwnProperty(r)?delete n.blacklist[r]:n.blacklist[r]=1,l({blacklist:n.blacklist},function(){o({disabled:p(n,t.tab?new URL(h(t)):null,e.blacklistPattern),blacklist:n.blacklist,url:r})})})},L.toggleMouseQuery=function(e,t,o){n("mouseSelectToQuery",function(n){if(t.tab&&0!==t.tab.url.indexOf(chrome.extension.getURL(""))){var o=n.mouseSelectToQuery||[],r=o.indexOf(e.origin);r===-1?o.push(e.origin):o.splice(r,1),l({mouseSelectToQuery:o})}})},L.getDisabled=function(e,t,o){n(["blacklist","noPdfViewer"],function(n){t.tab&&c(e,o,{noPdfViewer:n.noPdfViewer,disabled:p(n,new URL(h(t)),e.blacklistPattern)})})},L.addVIMark=function(e,t,o){n("marks",function(t){extendObject(t.marks,e.mark),l({marks:t.marks})})},L.jumpVIMark=function(e,t,o){n("marks",function(n){var i=n.marks;if(i.hasOwnProperty(e.mark)){var a=i[e.mark];chrome.tabs.query({},function(e){e=e.filter(function(e){return e.url===a.url}),0===e.length?(a.tab={tabbed:!0,active:!0},L.openLink(a,t,o)):((a.scrollLeft||a.scrollTop)&&(M[e[0].id]={scrollLeft:a.scrollLeft,scrollTop:a.scrollTop}),e[0].id===t.tab.id?r(e[0].id):chrome.tabs.update(e[0].id,{active:!0}))})}})},L.resetSettings=function(e,t,o){chrome.storage.local.clear(),chrome.storage.sync.clear(),n(null,function(t){_applyProxySettings(t),c(e,o,{settings:t}),d(t)})},L.loadSettingsFromUrl=function(e,t,n){m(e.url,function(t){c(e,n,t)})},L.getRecentlyClosed=function(e,t,n){chrome.sessions.getRecentlyClosed({},function(t){for(var o=[],r=0;r<t.length;r++){var i=t[r];i.hasOwnProperty("window")?o=o.concat(i.window.tabs):i.hasOwnProperty("tab")&&o.push(i.tab)}o=b(o,e.query),c(e,n,{urls:o})})},L.getTopSites=function(e,t,n){chrome.topSites.get(function(t){t=b(t,e.query),c(e,n,{urls:t})})},L.getAllURLs=function(e,t,n){chrome.bookmarks.getRecent(2147483647,function(t){var o=t;g(function(t){o=o.concat(t),c(e,n,{urls:o})},!0)})},L.getTabs=function(e,t,n){var o=t.tab,r=e.queryInfo||{};chrome.tabs.query(r,function(t){t=b(t,e.query),e.query&&e.query.length&&(t=t.filter(function(t){return t.title.indexOf(e.query)!==-1||t.url&&t.url.indexOf(e.query)!==-1})),t=t.filter(function(e){return e.id!==o.id}),H.tabsMRUOrder&&t.sort(function(e,t){var n=C[e.id],o=C[t.id];return isFinite(n)||isFinite(o)?isFinite(n)?isFinite(o)?o-n:-1:1:0}),c(e,n,{tabs:t})})},L.togglePinTab=function(e,t,n){s(function(e){return chrome.tabs.update(e.id,{pinned:!e.pinned})})},L.focusTab=function(e,t,n){void 0!==e.window_id&&t.tab.windowId!==e.window_id?chrome.windows.update(e.window_id,{focused:!0},function(){chrome.tabs.update(e.tab_id,{active:!0})}):chrome.tabs.update(e.tab_id,{active:!0})},L.focusTabByIndex=function(e,t,n){var o=e.queryInfo||{};chrome.tabs.query(o,function(t){e.repeats>0&&e.repeats<=t.length&&chrome.tabs.update(t[e.repeats-1].id,{active:!0})})},L.goToLastTab=function(e,t,n){if(_.length>1){var o=_[_.length-2];chrome.tabs.update(o,{active:!0})}},L.historyTab=function(e,t,n){if(_.length>0){A=!0,e.hasOwnProperty("index")?E=(parseInt(e.index)+_.length)%_.length:(E+=e.backward?-1:1,E<0?E=0:E>=_.length&&(E=_.length-1));var o=_[E];chrome.tabs.update(o,{active:!0})}},L.nextTab=function(e,t,n){w(t.tab,e.repeats)},L.previousTab=function(e,t,n){w(t.tab,-e.repeats)},L.reloadTab=function(e,t,n){x(t.tab,e.repeats,function(t){t.forEach(function(t){chrome.tabs.reload(t,{bypassCache:e.nocache})})})},L.closeTab=function(e,t,n){x(t.tab,e.repeats,function(e){chrome.tabs.remove(e,function(){"left"===H.focusAfterClosed?w(t.tab,-1):"last"===H.focusAfterClosed&&L.historyTab({backward:!0})})})},L.closeTabLeft=function(e,t,n){k(t,-e.repeats)},L.closeTabRight=function(e,t,n){k(t,e.repeats)},L.closeTabsToLeft=function(e,t,n){k(t,-t.tab.index)},L.closeTabsToRight=function(e,t,n){chrome.tabs.query({currentWindow:!0},function(e){k(t,e.length-t.tab.index)})},L.tabOnly=function(e,t,n){chrome.tabs.query({currentWindow:!0},function(e){e=e.map(function(e){return e.id}).filter(function(e){return e!=t.tab.id}),chrome.tabs.remove(e)})},L.muteTab=function(e,t,n){var o=t.tab;chrome.tabs.update(o.id,{muted:!o.mutedInfo.muted})},L.openLast=function(e,t,n){chrome.sessions.restore()},L.duplicateTab=function(e,t,n){chrome.tabs.duplicate(t.tab.id,function(){e.active===!1&&chrome.tabs.update(t.tab.id,{active:!0})})},L.newWindow=function(e,t,n){chrome.tabs.query({},function(e){var n={};if(e.forEach(function(e){n[e.windowId]=n[e.windowId]||[],n[e.windowId].push(e.id)}),n[t.tab.windowId]&&1===n[t.tab.windowId].length){var o,r=0;for(var i in n)n[i].length>r&&(r=n[i].length,o=i);chrome.tabs.move(t.tab.id,{windowId:parseInt(o),index:-1})}else chrome.windows.create({tabId:t.tab.id})})},L.getBookmarkFolders=function(t,n,o){chrome.bookmarks.getTree(function(n){B=[],e(n[0],""),c(t,o,{folders:B})})},L.createBookmark=function(e,n,o){O(e.page.url,function(){t(e.page,function(t){c(e,o,{bookmark:t})})})},L.getBookmarks=function(e,t,n){e.parentId?chrome.bookmarks.getSubTree(e.parentId,function(t){var o=t[0].children;e.query&&e.query.length&&(o=o.filter(function(t){return t.title.indexOf(e.query)!==-1||t.url&&t.url.indexOf(e.query)!==-1})),c(e,n,{bookmarks:o})}):e.query&&e.query.length?chrome.bookmarks.search(e.query,function(t){c(e,n,{bookmarks:t})}):chrome.bookmarks.getTree(function(t){c(e,n,{bookmarks:t[0].children})})},L.getHistory=function(e,t,n){g(function(t){c(e,n,{history:t})},e.sortByMostUsed)},L.openLink=function(e,t,n){var o=T(e.url);o.startsWith("javascript:")?chrome.tabs.executeScript(t.tab.id,{code:o.substr(11)}):e.tab.tabbed?0!==t.frameId&&chrome.extension.getURL("pages/frontend.html")===t.url||!t.tab?s(function(t){I(t,o,e)}):I(t.tab,o,e):chrome.tabs.update({url:o,pinned:e.tab.pinned||t.tab.pinned},function(t){(e.scrollLeft||e.scrollTop)&&(M[t.id]={scrollLeft:e.scrollLeft,scrollTop:e.scrollTop})})},L.viewSource=function(e,t,n){e.url="view-source:"+t.tab.url,L.openLink(e,t,n)},L.getSettings=function(e,t,o){var r=n;"RAW"===e.key&&(r=loadRawSettings,e.key=""),r(e.key,function(t){c(e,o,{settings:t})})},L.updateSettings=function(e,t,n){if("snippets"===e.scope)for(var o in e.settings)H.hasOwnProperty(o)&&(H[o]=e.settings[o]);else l(e.settings)},L.setSurfingkeysIcon=function(e,t,n){chrome.browserAction.setIcon({path:e.status?"icons/48-x.png":"icons/48.png",tabId:t.tab?t.tab.id:void 0})},L.request=function(e,t,n){request(e.url,function(t){c(e,n,{text:t})},e.headers,e.data)},L.nextFrame=function(e,t,n){var o=t.tab.id;chrome.tabs.executeScript(o,{allFrames:!0,matchAboutBlank:!0,code:"typeof(getFrameId) === 'function' && getFrameId()"},function(e){if(e=e.filter(function(e){return e}),e.length>0){var t=e[0];e.length>1&&(G.hasOwnProperty(o)||(G[o]=0),G[o]++,G[o]=G[o]%e.length,t=e[G[o]]),i(o,-1,{subject:"focusFrame",frameId:t})}})},L.moveTab=function(e,t,n){chrome.tabs.query({windowId:t.tab.windowId},function(n){var o=y(t.tab.index+e.step*e.repeats,n.length);chrome.tabs.move(t.tab.id,{index:o})})},L.quit=function(e,t,n){q()},L.createSession=function(e,t,o){n("sessions",function(t){chrome.tabs.query({},function(n){var o={};n.forEach(function(e){e&&void 0!==e.index&&(o.hasOwnProperty(e.windowId)||(o[e.windowId]=[]),e.url!==j&&o[e.windowId].push(e.url))});var r=[];for(var i in o)o[i].length&&r.push(o[i]);t.sessions[e.name]={},t.sessions[e.name].tabs=r,l({sessions:t.sessions},e.quitAfterSaved?q:void 0)})})},L.openSession=function(e,t,o){n("sessions",function(t){if(t.sessions.hasOwnProperty(e.name)){var n=t.sessions[e.name].tabs;n[0].forEach(function(e){chrome.tabs.create({url:e,active:!1,pinned:!1})});for(var o=1;o<n.length;o++){var r=n[o];chrome.windows.create({},function(e){r.forEach(function(t){chrome.tabs.create({windowId:e.id,url:t,active:!1,pinned:!1})})})}chrome.tabs.query({url:j},function(e){chrome.tabs.remove(e.map(function(e){return e.id}))})}})},L.deleteSession=function(e,t,o){n("sessions",function(t){delete t.sessions[e.name],l({sessions:t.sessions})})},L.closeDownloadsShelf=function(e,t,n){e.clearHistory?chrome.downloads.erase({urlRegex:".*"}):(chrome.downloads.setShelfEnabled(!1),chrome.downloads.setShelfEnabled(!0))},L.getDownloads=function(e,t,n){chrome.downloads.search(e.query,function(t){c(e,n,{downloads:t})})},L.executeScript=function(e,t,n){chrome.tabs.executeScript(t.tab.id,{frameId:t.frameId,code:e.code,matchAboutBlank:!0,file:e.file},function(t){c(e,n,{response:t})})},L.tabURLAccessed=function(e,t,n){if(t.tab){var o=t.tab.id;return F.hasOwnProperty(o)||(F[o]={}),F[o][e.url]=e.title,{active:t.tab.active,index:H.showTabIndices?t.tab.index+1:0}}return{}},L.getTabURLs=function(e,t,n){var o=F[t.tab.id]||{};return o=Object.keys(o).map(function(e){return{url:e,title:o[e]}}),{urls:o}},L.getTopURL=function(e,t,n){return{url:t.tab?t.tab.url:""}},L.updateProxy=function(e,t,n){P(e,function(t){c(e,n,t)})},L.setZoom=function(e,t,n){var o=t.tab.id,r=e.zoomFactor*e.repeats;0==r?chrome.tabs.setZoom(o,1):chrome.tabs.getZoom(o,function(e){chrome.tabs.setZoom(o,e+r)})},L.removeURL=function(e,t,n){function o(){r++,r===i&&c(e,n,{response:"Done"})}var r=0,i=e.uid.length,a=e.uid;"string"==typeof e.uid&&(i=1,a=[e.uid]),a.forEach(function(e){S(e,o)})},L.localData=function(e,t,n){e.data.constructor===Object?(chrome.storage.local.set(e.data,function(){}),d(e.data)):chrome.storage.local.get(e.data,function(t){c(e,n,{data:t})})},L.captureVisibleTab=function(e,t,n){chrome.tabs.captureVisibleTab(null,{format:"png"},function(t){c(e,n,{dataUrl:t})})},L.getCaptureSize=function(e,t,n){var o=document.createElement("img");o.onload=function(){c(e,n,{width:o.width,height:o.height})},chrome.tabs.captureVisibleTab(null,{format:"png"},function(e){o.src=e})},L.deleteHistoryOlderThan=function(e,t,n){var o=e.days||0,r=e.hours||0;chrome.history.deleteRange({startTime:0,endTime:(new Date).getTime()-1e3*(86400*o+3600*r)},function(){})},L.removeBookmark=function(e,t,n){O(t.tab.url)},L.getBookmark=function(e,t,n){chrome.bookmarks.search({url:t.tab.url},function(t){c(e,n,{bookmarks:t})})},L.initGist=function(e,t,n){return Gist.initGist(e.token,function(t){c(e,n,{gist:t})})},L.readComment=function(e,t,n){Gist.readComment(e.index,function(t){c(e,n,t)})},L.editComment=function(e,t,n){Gist.editComment(e.index,e.content,function(t){c(e,n,{gistResp:t})})};var V=[];L.queueURLs=function(e,t,n){V=V.concat(e.urls)},L.getQueueURLs=function(e,t,n){return{queueURLs:V}},L.getVoices=function(e,t,n){chrome.tts.getVoices(function(t){c(e,n,{voices:t})})},L.read=function(e,t,n){var o=e.options||{};o.onEvent=function(t){c(e,n,{ttsEvent:t})},chrome.tts.speak(e.content,o)},L.stopReading=function(e,t,n){chrome.tts.stop()},L.openIncognito=function(e,t,n){chrome.windows.create({url:e.url,incognito:!0})};var z;return L.setUserAgent=function(e,t,n){e.userAgent?(z=e.userAgent,chrome.webRequest.onBeforeSendHeaders.addListener(R,{urls:["<all_urls>"]},["blocking","requestHeaders"])):chrome.webRequest.onBeforeSendHeaders.removeListener(R),chrome.tabs.reload(t.tab.id)},chrome.runtime.setUninstallURL("http://brookhong.github.io/2018/01/30/why-did-you-uninstall-surfingkeys.html"),L}();